{% extends "layouts/dashboard.html" %}

{% block title %}User Management | Billing Circle{% endblock %}

{% block dashboard_content %}
<div class="row mb-5 align-items-center">
    <div class="col">
        <h1 class="h3 fw-bold mb-1">User Management</h1>
        <p class="text-muted mb-0">Managing <span
                class="badge bg-primary-subtle text-primary border border-primary-soft text-capitalize">{{ role
                }}s</span> across the organization.</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary px-4" id="btnInviteUser" data-bs-toggle="modal"
            data-bs-target="#inviteUserModal">
            <i class="bi bi-person-plus me-2"></i>Invite {{ role | capitalize }}
        </button>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 py-3">User</th>
                        <th class="py-3">Role</th>
                        <th class="py-3">Last Active</th>
                        <th class="py-3">Status</th>
                        <th class="text-end pe-4 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody id="userListBody">
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="spinner-border text-primary spinner-border-sm me-2"></div>
                            Loading users...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


{% endblock %}

{% block modals %}
<!-- Invite User Modal -->
<div class="modal fade" id="inviteUserModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg px-2">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="fw-bold"><i class="bi bi-person-plus me-2 text-primary"></i>Invite New {{ role | capitalize
                    }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="inviteUserForm">
                <div class="modal-body px-4">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Full Name</label>
                        <input type="text" class="form-control" name="full_name" required placeholder="John Doe">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Email Address</label>
                        <input type="email" class="form-control" name="email" required placeholder="john@example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Set Password</label>
                        <input type="password" class="form-control" name="password" required
                            placeholder="Minimum 8 characters">
                    </div>
                </div>
                <div class="modal-footer border-0 pb-4 px-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Invite User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
    const userRole = "{{ role }}";
    const userListBody = document.getElementById('userListBody');
    const inviteForm = document.getElementById('inviteUserForm');

    async function loadUsers() {
        try {
            const resp = await axios.get(`${API_URL}/users/`, { params: { role: userRole } });
            const users = resp.data;

            if (users.length === 0) {
                userListBody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted">No ${userRole}s found.</td></tr>`;
                return;
            }

            userListBody.innerHTML = users.map(u => `
                <tr class="align-middle">
                    <td class="ps-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle bg-primary-subtle text-primary me-3"
                                style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold;">
                                ${u.full_name ? u.full_name[0].toUpperCase() : 'U'}
                            </div>
                            <div>
                                <div class="fw-bold text-dark">${u.full_name || 'Anonymous'}</div>
                                <div class="small text-muted">${u.email}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-light text-dark text-capitalize">${u.role}</span></td>
                    <td class="text-muted small">---</td>
                    <td>
                        <span class="badge ${u.is_active ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'} border rounded-pill px-3">
                            ${u.is_active ? 'ACTIVE' : 'INACTIVE'}
                        </span>
                    </td>
                    <td class="text-end pe-4">
                        <div class="btn-group shadow-sm">
                            <button class="btn btn-white btn-sm border rounded-pill px-3 me-2" onclick="window.ui.showToast('Detailed user management coming soon!', 'info')">Edit</button>
                            <button class="btn btn-white btn-sm border text-danger rounded-circle" style="width: 32px; height: 32px; padding: 0;" title="Delete User" onclick="deleteUser('${u.user_id}', '${u.full_name}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            console.error(e);
            userListBody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-danger">Failed to load users.</td></tr>';
        }
    }

    async function deleteUser(userId, name) {
        window.ui.confirmDelete({
            title: 'Delete User',
            message: `Are you sure you want to delete ${name}? This action cannot be undone.`,
            onConfirm: async () => {
                await axios.delete(`${API_URL}/users/${userId}`);
                window.ui.showToast('User deleted successfully', 'success');
                loadUsers();
            }
        });
    }

    inviteForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.role = userRole;

        try {
            await axios.post(`${API_URL}/users/`, data);
            window.ui.showToast('User invited successfully!', 'success');

            // Close modal
            const modalEl = document.getElementById('inviteUserModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.hide();

            inviteForm.reset();
            loadUsers();
            checkLimits(); // Refresh limits after addition
        } catch (err) {
            console.error(err);
            const msg = err.response?.data?.detail || 'Failed to invite user.';
            window.ui.showToast(msg, 'danger');
        }
    });

    async function checkLimits() {
        try {
            const resp = await axios.get(`${API_URL}/subscriptions/status`);
            const { usage, details } = resp.data;
            const btn = document.getElementById('btnInviteUser');

            if (details.limits.users !== -1 && usage.users >= details.limits.users) {
                btn.classList.add('disabled');
                btn.classList.replace('btn-primary', 'btn-light');
                btn.setAttribute('title', 'User limit reached for your plan. Upgrade to invite more team members.');
                btn.setAttribute('data-bs-toggle', 'tooltip');
                new bootstrap.Tooltip(btn);
            }
        } catch (e) {
            console.error("Limit check failed", e);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadUsers();
        checkLimits();
    });
</script>
{% endblock %}