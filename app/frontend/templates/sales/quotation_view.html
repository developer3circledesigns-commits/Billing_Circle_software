{% extends "layouts/dashboard.html" %}

{% block title %}View Quotation | Billing Circle{% endblock %}

{% block dashboard_content %}
<div class="quotation-view-page">
    <!-- Page Header -->
    <div class="page-header d-print-none">
        <div class="header-content">
            <div class="header-left">
                <nav class="breadcrumb-nav">
                    <a href="/quotations" class="breadcrumb-back">
                        <i class="bi bi-arrow-left"></i>
                        <span>Back to Quotations</span>
                    </a>
                </nav>
                <div class="header-title">
                    <h1>Quotation Details</h1>
                    <p class="subtitle">Review price estimate and valid dates</p>
                </div>
            </div>
            <div class="header-right">
                <div class="action-buttons">
                    <div class="action-group">
                        <button class="btn-action btn-print" onclick="window.print()" title="Print">
                            <i class="bi bi-printer"></i>
                            <span class="btn-label">Print</span>
                        </button>
                        <button class="btn-action btn-pdf" onclick="downloadPDF()" title="Download PDF">
                            <i class="bi bi-file-earmark-pdf"></i>
                            <span class="btn-label">PDF</span>
                        </button>
                        <button class="btn-action btn-share" onclick="shareQuotation()" title="Share">
                            <i class="bi bi-share"></i>
                            <span class="btn-label">Share</span>
                        </button>
                    </div>
                    <button class="btn-convert" id="btnConvertToInvoice">
                        <i class="bi bi-receipt"></i>
                        <span>Convert to Invoice</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quotation Content -->
    <div class="quotation-container" id="printableArea">
        <!-- Header Section -->
        <div class="quotation-header">
            <div class="company-info">
                <div class="company-logo">
                    <div class="logo-placeholder" id="companyLogo">
                        <span id="orgInitials">BC</span>
                    </div>
                </div>
                <div class="company-details">
                    <h2 id="orgName">Loading Company...</h2>
                    <div class="contact-info">
                        <div id="orgAddress" class="address">Loading address...</div>
                        <div id="orgContact" class="contact-details"></div>
                    </div>
                </div>
            </div>

            <div class="quotation-meta">
                <div class="document-title">
                    <span class="title-text">PRICE QUOTATION</span>
                    <div class="quotation-number" id="qNumber">Loading...</div>
                </div>
                <div class="status-badge" id="qStatus">
                    <span class="status-text">Status: Loading...</span>
                </div>
            </div>
        </div>

        <!-- Divider -->
        <div class="divider"></div>

        <!-- Quotation Details -->
        <div class="quotation-details-section">
            <div class="bill-to-section">
                <div class="section-title">Quote To:</div>
                <div class="customer-info">
                    <h3 id="qCustomer">Loading Customer...</h3>
                    <div id="qCustomerAddress" class="customer-address">Loading address...</div>
                    <div id="qCustomerContact" class="customer-contact"></div>
                </div>
            </div>

            <div class="quotation-info">
                <table class="info-table">
                    <tbody>
                        <tr>
                            <td class="label">Quotation Date:</td>
                            <td class="value" id="qDate">---</td>
                        </tr>
                        <tr>
                            <td class="label">Valid Until:</td>
                            <td class="value" id="qValid">---</td>
                        </tr>
                        <tr>
                            <td class="label">Quotation ID:</td>
                            <td class="value" id="qId">---</td>
                        </tr>
                        <tr>
                            <td class="label">Reference:</td>
                            <td class="value" id="qReference">---</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Items Table -->
        <div class="items-section">
            <div class="table-responsive">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th class="serial">#</th>
                            <th class="description">Item Description</th>
                            <th class="quantity">Qty</th>
                            <th class="unit">Unit</th>
                            <th class="rate">Rate (₹)</th>
                            <th class="tax">Tax %</th>
                            <th class="amount">Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody id="qItems">
                        <!-- Loading state -->
                        <tr class="loading-row">
                            <td colspan="7" class="text-center py-4">
                                <div class="loading-indicator">
                                    <div class="spinner"></div>
                                    <span>Loading items...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Totals Section -->
        <div class="totals-section">
            <div class="totals-wrapper">
                <div class="total-row">
                    <span class="total-label">Sub Total:</span>
                    <span class="total-value" id="qSub">₹ 0.00</span>
                </div>
                <div class="total-row">
                    <span class="total-label">Tax (GST):</span>
                    <span class="total-value" id="qTax">₹ 0.00</span>
                </div>
                <div class="total-row grand-total">
                    <span class="total-label">Grand Total:</span>
                    <span class="total-value" id="qGrand">₹ 0.00</span>
                </div>
            </div>
        </div>

        <!-- Notes & Terms -->
        <div class="notes-terms-section">
            <div class="notes-section">
                <div class="section-header">
                    <i class="bi bi-chat-left-text"></i>
                    <h4>Notes</h4>
                </div>
                <div class="section-content">
                    <div id="qNotes" class="notes-content">
                        <em class="empty-state">No notes provided</em>
                    </div>
                </div>
            </div>

            <div class="terms-section">
                <div class="section-header">
                    <i class="bi bi-file-text"></i>
                    <h4>Terms & Conditions</h4>
                </div>
                <div class="section-content">
                    <div id="qTerms" class="terms-content">
                        <em class="empty-state">No terms specified</em>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="quotation-footer">
            <div class="footer-content">
                <div class="thank-you">
                    Thank you for choosing <span id="orgNameFoot">---</span>. We look forward to working with you.
                </div>
                <div class="legal-info">
                    Terms & Conditions Apply. All prices are inclusive of GST as indicated.
                </div>
                <div class="generated-info" id="qGeneratedInfo">
                    Generated on ---
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal" id="shareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="bi bi-share-fill"></i>
                    <h5>Share Quotation</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Native Share -->
                <div class="native-share-section" id="nativeShareSection" style="display: none;">
                    <button class="btn-native-share" onclick="shareViaWebAPI()">
                        <i class="bi bi-share-fill"></i>
                        <div class="share-text">
                            <div class="share-title">Share via...</div>
                            <div class="share-subtitle">Use system share options</div>
                        </div>
                    </button>
                    <div class="divider-text">
                        <span>or share via</span>
                    </div>
                </div>

                <!-- Social Share Buttons -->
                <div class="social-share-grid">
                    <button class="social-share-btn whatsapp" onclick="shareViaWhatsApp()">
                        <i class="bi bi-whatsapp"></i>
                        <span>WhatsApp</span>
                    </button>
                    <button class="social-share-btn email" onclick="shareViaEmail()">
                        <i class="bi bi-envelope"></i>
                        <span>Email</span>
                    </button>
                    <button class="social-share-btn telegram" onclick="shareViaTelegram()">
                        <i class="bi bi-telegram"></i>
                        <span>Telegram</span>
                    </button>
                    <button class="social-share-btn sms" onclick="shareViaSMS()">
                        <i class="bi bi-chat-dots"></i>
                        <span>SMS</span>
                    </button>
                </div>

                <!-- Link Section -->
                <div class="link-section">
                    <label class="section-label">Quotation Link</label>
                    <div class="link-input-group">
                        <input type="text" class="link-input" id="quotationLink" readonly value="Loading...">
                        <button class="btn-copy" onclick="copyLink()">
                            <i class="bi bi-clipboard"></i>
                            <span class="copy-text">Copy</span>
                        </button>
                    </div>
                </div>

                <!-- QR Code -->
                <div class="qrcode-section">
                    <button class="btn-qr-toggle" type="button" data-bs-toggle="collapse"
                        data-bs-target="#qrcodeCollapse">
                        <i class="bi bi-qr-code"></i>
                        <span>Show QR Code</span>
                    </button>
                    <div class="collapse" id="qrcodeCollapse">
                        <div class="qrcode-container">
                            <div id="qrcode"></div>
                            <p class="qrcode-note">Scan to view quotation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast (Hidden) -->
<div class="toast-container" id="toastContainer">
    <div class="toast" role="alert">
        <div class="toast-body">
            <i class="bi bi-check-circle-fill toast-icon success"></i>
            <div class="toast-content">
                <div class="toast-title">Success</div>
                <div class="toast-message">Operation completed successfully</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Backdrop Fix Container -->
<div class="modal-backdrop-fix"></div>
{% endblock %}

{% block extra_css %}
<style>
    /* Base Variables */
    :root {
        --primary: #4361ee;
        --primary-light: #eef2ff;
        --primary-dark: #3a56d4;
        --secondary: #64748b;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --light: #f8fafc;
        --dark: #1e293b;
        --border: #e2e8f0;
        --border-light: #f1f5f9;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
        --radius: 12px;
        --radius-sm: 8px;
    }

    /* Reset & Base */
    .quotation-view-page {
        padding: 0;
        min-height: 100vh;
        background: var(--light);
        position: relative;
    }



    /* Ensure modals are above everything */
    .modal {
        z-index: 1050;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        outline: 0;
    }

    /* Page Header */
    .page-header {
        background: white;
        border-bottom: 1px solid var(--border);
        padding: 1.5rem 0;
        margin-bottom: 2rem;
        position: relative;
        z-index: 100;
    }

    .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    @media (min-width: 768px) {
        .header-content {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
    }

    .header-left {
        flex: 1;
    }

    .breadcrumb-nav {
        margin-bottom: 0.75rem;
    }

    .breadcrumb-back {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--secondary);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.2s;
    }

    .breadcrumb-back:hover {
        color: var(--primary);
    }

    .breadcrumb-back i {
        font-size: 1rem;
    }

    .header-title h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0 0 0.25rem 0;
    }

    .subtitle {
        color: var(--secondary);
        font-size: 0.95rem;
        margin: 0;
    }

    /* Header Actions */
    .header-right {
        flex-shrink: 0;
        position: relative;
    }

    .action-buttons {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        position: relative;
        z-index: 101;
    }

    .action-group {
        display: flex;
        gap: 0.5rem;
    }

    .btn-action {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        background: white;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--secondary);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        position: relative;
        z-index: 1;
    }

    .btn-action:hover {
        background: var(--light);
        border-color: var(--primary);
        color: var(--primary);
        transform: translateY(-1px);
    }

    .btn-action i {
        font-size: 1rem;
    }

    .btn-label {
        display: none;
    }

    @media (min-width: 640px) {
        .btn-label {
            display: inline;
        }
    }

    .btn-print:hover {
        color: #06b6d4;
        border-color: #06b6d4;
    }

    .btn-pdf:hover {
        color: #ef4444;
        border-color: #ef4444;
    }

    .btn-share:hover {
        color: #10b981;
        border-color: #10b981;
    }

    /* Dropdown Container - Fixed for backdrop issues */
    .dropdown-container {
        position: relative;
        display: inline-block;
    }

    .dropdown-container .dropdown-toggle {
        position: relative;
        z-index: 102;
    }

    .dropdown-container .dropdown-menu {
        position: absolute !important;
        top: 100% !important;
        left: auto !important;
        right: 0 !important;
        margin-top: 0.5rem !important;
        z-index: 1030 !important;
        transform: none !important;
        will-change: transform, opacity;
        display: none;
    }

    .dropdown-container .dropdown-menu.show {
        display: block;
        animation: dropdownSlide 0.2s ease;
    }

    @keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .btn-more {
        padding: 0.625rem;
    }

    .dropdown-menu {
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-lg);
        padding: 0.5rem;
        min-width: 180px;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem 0.875rem;
        border-radius: 6px;
        color: var(--dark);
        text-decoration: none;
        transition: all 0.2s;
        font-size: 0.875rem;
        cursor: pointer;
    }

    .dropdown-item:hover {
        background: var(--primary-light);
        color: var(--primary);
    }

    .dropdown-item i {
        width: 16px;
        text-align: center;
    }

    .dropdown-divider {
        margin: 0.5rem;
        border-color: var(--border);
    }

    .btn-convert {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        background: var(--primary);
        border: none;
        border-radius: var(--radius-sm);
        color: white;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        z-index: 1;
    }

    .btn-convert:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-convert:disabled,
    .btn-convert.disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Quotation Container */
    .quotation-container {
        max-width: 1000px;
        margin: 0 auto 3rem;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        position: relative;
        z-index: 1;
    }

    /* Quotation Header */
    .quotation-header {
        padding: 2.5rem 2.5rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    @media (min-width: 768px) {
        .quotation-header {
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
        }
    }

    .company-info {
        display: flex;
        gap: 1.5rem;
        align-items: flex-start;
    }

    .company-logo {
        flex-shrink: 0;
    }

    .logo-placeholder {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, var(--primary), #667eea);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .company-details {
        flex: 1;
    }

    .company-details h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0 0 0.5rem 0;
    }

    .contact-info {
        color: var(--secondary);
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .contact-details {
        margin-top: 0.25rem;
        color: #64748b;
        font-size: 0.875rem;
    }

    /* Quotation Meta */
    .quotation-meta {
        text-align: left;
    }

    @media (min-width: 768px) {
        .quotation-meta {
            text-align: right;
        }
    }

    .document-title {
        margin-bottom: 1rem;
    }

    .title-text {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--secondary);
        margin-bottom: 0.25rem;
    }

    .quotation-number {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--primary);
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: var(--light);
        border: 1px solid var(--border);
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .status-text {
        color: var(--secondary);
    }

    /* Divider */
    .divider {
        height: 1px;
        background: linear-gradient(to right, transparent, var(--border), transparent);
        margin: 0 2.5rem;
    }

    /* Quotation Details Section */
    .quotation-details-section {
        padding: 1.5rem 2.5rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }

    @media (min-width: 768px) {
        .quotation-details-section {
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
        }
    }

    .bill-to-section .section-title {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--secondary);
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
    }

    .customer-info h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0 0 0.5rem 0;
    }

    .customer-address,
    .customer-contact {
        color: var(--secondary);
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .customer-contact {
        margin-top: 0.5rem;
    }

    /* Info Table */
    .info-table {
        width: 100%;
    }

    .info-table tr {
        border-bottom: 1px solid var(--border-light);
    }

    .info-table tr:last-child {
        border-bottom: none;
    }

    .info-table td {
        padding: 0.625rem 0;
        vertical-align: top;
    }

    .info-table .label {
        color: var(--secondary);
        font-size: 0.875rem;
        font-weight: 500;
        padding-right: 1.5rem;
        white-space: nowrap;
    }

    .info-table .value {
        color: var(--dark);
        font-size: 0.95rem;
        font-weight: 600;
        text-align: right;
    }

    /* Items Section */
    .items-section {
        padding: 0 2.5rem;
        margin: 1.5rem 0;
        position: relative;
    }

    .table-responsive {
        overflow-x: auto;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        position: relative;
        z-index: 1;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
    }

    .items-table thead {
        background: var(--light);
    }

    .items-table th {
        padding: 1rem 1.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--secondary);
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .items-table th.serial {
        width: 40px;
        text-align: center;
    }

    .items-table th.quantity,
    .items-table th.unit,
    .items-table th.tax {
        width: 80px;
        text-align: center;
    }

    .items-table th.rate,
    .items-table th.amount {
        width: 100px;
        text-align: right;
    }

    .items-table tbody tr {
        border-bottom: 1px solid var(--border-light);
        transition: background 0.2s;
    }

    .items-table tbody tr:hover {
        background: var(--primary-light);
    }

    .items-table td {
        padding: 1.25rem 1.25rem;
        vertical-align: top;
    }

    .items-table td.serial {
        text-align: center;
        color: var(--secondary);
        font-weight: 500;
    }

    .items-table td.description {
        max-width: 300px;
    }

    .items-table td.description .item-name {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.25rem;
    }

    .items-table td.description .item-details {
        color: var(--secondary);
        font-size: 0.875rem;
    }

    .items-table td.quantity,
    .items-table td.unit,
    .items-table td.tax {
        text-align: center;
        font-weight: 500;
    }

    .items-table td.rate,
    .items-table td.amount {
        text-align: right;
        font-weight: 600;
    }

    .loading-row td {
        text-align: center;
        padding: 3rem !important;
    }

    .loading-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        color: var(--secondary);
    }

    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--primary-light);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Totals Section */
    .totals-section {
        padding: 1.5rem 2.5rem;
        background: var(--light);
        margin: 1.5rem 2.5rem;
        border-radius: var(--radius-sm);
        position: relative;
        z-index: 1;
    }

    .totals-wrapper {
        max-width: 400px;
        margin-left: auto;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.875rem 0;
        border-bottom: 1px solid var(--border);
    }

    .total-row:last-child {
        border-bottom: none;
    }

    .total-label {
        font-size: 0.95rem;
        color: var(--secondary);
    }

    .total-value {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--dark);
    }

    .grand-total {
        padding-top: 1rem;
        margin-top: 0.5rem;
        border-top: 2px solid var(--border);
    }

    .grand-total .total-label {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
    }

    .grand-total .total-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary);
    }

    /* Notes & Terms */
    .notes-terms-section {
        padding: 1.5rem 2.5rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-top: 2rem;
        position: relative;
        z-index: 1;
    }

    @media (min-width: 768px) {
        .notes-terms-section {
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
        }
    }

    .notes-section,
    .terms-section {
        background: var(--light);
        border-radius: var(--radius-sm);
        overflow: hidden;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        background: white;
        border-bottom: 1px solid var(--border);
    }

    .section-header i {
        color: var(--primary);
        font-size: 1rem;
    }

    .section-header h4 {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
    }

    .section-content {
        padding: 1.5rem;
    }

    .notes-content,
    .terms-content {
        color: var(--secondary);
        font-size: 0.875rem;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    .empty-state {
        color: #94a3b8;
        font-style: italic;
    }

    /* Quotation Footer */
    .quotation-footer {
        padding: 2.5rem;
        background: var(--light);
        border-top: 1px solid var(--border);
        margin-top: 2rem;
        position: relative;
        z-index: 1;
    }

    .footer-content {
        text-align: center;
        max-width: 600px;
        margin: 0 auto;
    }

    .thank-you {
        font-size: 0.95rem;
        color: var(--dark);
        margin-bottom: 0.75rem;
        font-weight: 500;
    }

    .legal-info {
        font-size: 0.75rem;
        color: var(--secondary);
        margin-bottom: 1rem;
    }

    .generated-info {
        font-size: 0.75rem;
        color: #94a3b8;
        font-style: italic;
    }

    /* Share Modal */
    .modal {
        z-index: 1055 !important;
    }

    .modal-content {
        border: none;
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        position: relative;
        z-index: 1056;
    }

    .modal-header {
        padding: 1.5rem 1.5rem 1rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .modal-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .modal-title i {
        color: var(--primary);
        font-size: 1.25rem;
    }

    .modal-title h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
    }

    .modal-body {
        padding: 1.5rem;
    }

    /* Native Share */
    .native-share-section {
        margin-bottom: 1.5rem;
    }

    .btn-native-share {
        width: 100%;
        padding: 1rem;
        background: var(--primary-light);
        border: 2px dashed var(--primary);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        gap: 1rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-native-share:hover {
        background: var(--primary);
        border-color: var(--primary);
    }

    .btn-native-share:hover i,
    .btn-native-share:hover .share-title,
    .btn-native-share:hover .share-subtitle {
        color: white;
    }

    .btn-native-share i {
        font-size: 1.5rem;
        color: var(--primary);
    }

    .share-text {
        text-align: left;
    }

    .share-title {
        font-weight: 600;
        color: var(--dark);
        font-size: 0.95rem;
    }

    .share-subtitle {
        font-size: 0.75rem;
        color: var(--secondary);
    }

    .divider-text {
        text-align: center;
        margin: 1rem 0;
        position: relative;
    }

    .divider-text span {
        background: white;
        padding: 0 1rem;
        font-size: 0.75rem;
        color: var(--secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .divider-text:before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--border);
        z-index: -1;
    }

    /* Social Share Grid */
    .social-share-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .social-share-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .social-share-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .social-share-btn i {
        font-size: 1.5rem;
    }

    .social-share-btn span {
        font-size: 0.875rem;
        font-weight: 500;
    }

    .social-share-btn.whatsapp {
        color: #25d366;
        border-color: #25d366;
    }

    .social-share-btn.whatsapp:hover {
        background: #25d366;
        color: white;
    }

    .social-share-btn.email {
        color: var(--primary);
        border-color: var(--primary);
    }

    .social-share-btn.email:hover {
        background: var(--primary);
        color: white;
    }

    .social-share-btn.telegram {
        color: #0088cc;
        border-color: #0088cc;
    }

    .social-share-btn.telegram:hover {
        background: #0088cc;
        color: white;
    }

    .social-share-btn.sms {
        color: var(--secondary);
        border-color: var(--secondary);
    }

    .social-share-btn.sms:hover {
        background: var(--secondary);
        color: white;
    }

    /* Link Section */
    .link-section {
        margin-bottom: 1.5rem;
    }

    .section-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--secondary);
        margin-bottom: 0.5rem;
        letter-spacing: 0.5px;
    }

    .link-input-group {
        display: flex;
        gap: 0.5rem;
    }

    .link-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        color: var(--dark);
        background: var(--light);
    }

    .link-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .btn-copy {
        padding: 0.75rem 1.25rem;
        background: var(--primary);
        border: none;
        border-radius: var(--radius-sm);
        color: white;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background 0.2s;
    }

    .btn-copy:hover {
        background: var(--primary-dark);
    }

    .copy-text {
        display: none;
    }

    @media (min-width: 400px) {
        .copy-text {
            display: inline;
        }
    }

    /* QR Code Section */
    .qrcode-section {
        text-align: center;
    }

    .btn-qr-toggle {
        padding: 0.75rem 1.25rem;
        background: white;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--secondary);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .btn-qr-toggle:hover {
        background: var(--light);
        color: var(--dark);
    }

    .qrcode-container {
        padding: 1.5rem;
        background: white;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        margin-top: 1rem;
    }

    #qrcode {
        display: inline-block;
        padding: 1rem;
        background: white;
        border-radius: 8px;
    }

    .qrcode-note {
        font-size: 0.75rem;
        color: var(--secondary);
        margin-top: 0.75rem;
        margin-bottom: 0;
    }

    /* Toast */
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1080;
    }

    .toast {
        background: white;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-lg);
        max-width: 350px;
        animation: toastSlide 0.3s ease;
        position: relative;
        z-index: 1081;
    }

    @keyframes toastSlide {
        from {
            opacity: 0;
            transform: translateX(100%);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .toast-body {
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .toast-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .toast-icon.success {
        color: var(--success);
    }

    .toast-content {
        flex: 1;
    }

    .toast-title {
        font-weight: 600;
        color: var(--dark);
        font-size: 0.875rem;
        margin-bottom: 0.125rem;
    }

    .toast-message {
        font-size: 0.8125rem;
        color: var(--secondary);
    }

    /* Prevent body scroll when modal is open */
    body.modal-open {
        overflow: hidden;
        padding-right: 0 !important;
    }



    .modal.show {
        z-index: 1055 !important;
    }

    /* Print Styles */
    @media print {
        .d-print-none {
            display: none !important;
        }

        body {
            background: white !important;
            font-size: 12pt;
            overflow: visible !important;
        }

        .quotation-view-page {
            padding: 0 !important;
            background: white !important;
            overflow: visible !important;
        }

        .quotation-container {
            box-shadow: none !important;
            border: 1px solid #ddd !important;
            margin: 0 !important;
            max-width: 100% !important;
            page-break-inside: avoid !important;
        }

        .header-content,
        .action-buttons,
        .modal,
        .toast-container,
        .modal-backdrop {
            display: none !important;
        }

        .quotation-header,
        .quotation-details-section,
        .items-section,
        .totals-section,
        .notes-terms-section,
        .quotation-footer {
            padding: 0.5cm !important;
            page-break-inside: avoid !important;
        }

        .divider {
            margin: 0 0.5cm !important;
        }

        .table-responsive {
            overflow: visible !important;
            border: none !important;
            page-break-inside: avoid !important;
        }

        .items-table {
            min-width: auto !important;
            page-break-inside: avoid !important;
        }

        .items-table th,
        .items-table td {
            padding: 0.25cm !important;
        }

        .logo-placeholder {
            background: #333 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .totals-section,
        .notes-section,
        .terms-section,
        .quotation-footer {
            background: #f8f9fa !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Prevent page breaks inside important sections */
        .quotation-container>* {
            page-break-inside: avoid !important;
        }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {

        .header-content,
        .quotation-header,
        .quotation-details-section,
        .items-section,
        .totals-section,
        .notes-terms-section,
        .quotation-footer {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .page-header {
            padding: 1rem 0;
        }

        .action-buttons {
            width: 100%;
            justify-content: space-between;
        }

        .btn-action span.btn-label {
            display: none;
        }

        .company-info {
            flex-direction: column;
            gap: 1rem;
        }

        .logo-placeholder {
            width: 48px;
            height: 48px;
        }

        .items-table {
            font-size: 0.875rem;
        }

        .items-table th,
        .items-table td {
            padding: 0.75rem 0.5rem;
        }

        .social-share-grid {
            grid-template-columns: 1fr;
        }

        /* Mobile modal adjustments */
        .modal-dialog {
            margin: 0.5rem;
        }

        .modal-content {
            margin: 0;
        }
    }

    @media (max-width: 480px) {
        .action-buttons {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }

        .action-group {
            justify-content: center;
            width: 100%;
        }

        .btn-convert {
            width: 100%;
            justify-content: center;
        }

        .company-details h2 {
            font-size: 1.25rem;
        }

        .quotation-number {
            font-size: 1.5rem;
        }

        .customer-info h3 {
            font-size: 1.1rem;
        }

        .info-table td {
            display: block;
            padding: 0.25rem 0;
        }

        .info-table .label {
            display: inline-block;
            width: 120px;
            font-size: 0.75rem;
        }

        .info-table .value {
            display: inline;
            font-weight: normal;
            font-size: 0.875rem;
        }

        /* Ensure dropdowns are properly positioned on mobile */
        .dropdown-container .dropdown-menu {
            position: fixed !important;
            top: auto !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            margin: 0 !important;
            border-radius: var(--radius) var(--radius) 0 0 !important;
            animation: slideUp 0.3s ease !important;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }
    }

    /* Clear backdrop fix */
    .modal-backdrop-fix {
        display: none;
    }

    /* Ensure proper stacking order */
    .quotation-view-page>* {
        position: relative;
        z-index: 1;
    }

    /* Fix for iOS Safari backdrop issues */
    @supports (-webkit-touch-callout: none) {
        .modal {
            -webkit-overflow-scrolling: touch;
        }

        .modal-open {
            position: fixed;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Get quotation ID from template
    const quoteId = "{{ quote_id }}";
    // Robust access to API_URL
    const APP_API_URL = (typeof API_URL !== 'undefined') ? API_URL : window.location.origin + '/api';

    // Global state
    let currentQuotation = null;
    let shareModal = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
        if (!quoteId) {
            showToast('Quotation ID is missing', 'danger');
            setTimeout(() => window.location.href = '/quotations', 2000);
            return;
        }

        // Initialize Bootstrap components properly
        initializeBootstrapComponents();

        // Load organization info and quotation data
        await Promise.all([loadOrganization(), loadQuotation()]);

        // Initialize QR code after data is loaded
        initQRCode();
    });


    // Initialize Bootstrap components with proper cleanup
    function initializeBootstrapComponents() {
        // Initialize dropdowns with proper event handling
        const dropdownTriggers = document.querySelectorAll('.dropdown-toggle');
        dropdownTriggers.forEach(trigger => {
            // Remove any existing event listeners
            trigger.removeEventListener('click', handleDropdownClick);
            trigger.addEventListener('click', handleDropdownClick);
        });

        // Initialize modal with proper options
        const modalElement = document.getElementById('shareModal');
        if (modalElement) {
            // Clean up any existing modal instance
            const existingModal = bootstrap.Modal.getInstance(modalElement);
            if (existingModal) {
                existingModal.dispose();
            }

            shareModal = new bootstrap.Modal(modalElement, {
                backdrop: false,
                keyboard: true,
                focus: true
            });

            // Clean event listeners on modal hide
            modalElement.addEventListener('hidden.bs.modal', function () {
                // Remove modal-open class from body
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            });

            // Clean event listeners on modal show
            modalElement.addEventListener('show.bs.modal', function () {
                // Ensure body doesn't scroll
                document.body.classList.add('modal-open');
                document.body.style.overflow = 'hidden';
            });
        }

        // Initialize collapse components
        const collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
        collapseElements.forEach(element => {
            element.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('data-bs-target'));
                if (target) {
                    const collapse = new bootstrap.Collapse(target, {
                        toggle: true
                    });
                }
            });
        });
    }

    // Handle dropdown clicks properly
    function handleDropdownClick(e) {
        e.preventDefault();
        e.stopPropagation();

        const dropdown = this.closest('.dropdown-container');
        const menu = dropdown.querySelector('.dropdown-menu');

        // Close all other dropdowns
        document.querySelectorAll('.dropdown-menu.show').forEach(openMenu => {
            if (openMenu !== menu) {
                openMenu.classList.remove('show');
            }
        });

        // Toggle current dropdown
        menu.classList.toggle('show');

        // Close dropdown when clicking outside
        const closeDropdown = (e) => {
            if (!dropdown.contains(e.target)) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeDropdown);
            }
        };

        document.addEventListener('click', closeDropdown);
    }

    // Load organization details
    async function loadOrganization() {
        try {
            const response = await axios.get(`${APP_API_URL}/auth/organization`);
            const org = response.data;

            if (org) {
                // Update organization name
                document.getElementById('orgName').textContent = org.company_name || 'Your Company';
                document.getElementById('orgNameFoot').textContent = org.company_name || 'Your Company';

                // Set company initials for logo
                const initials = org.company_name
                    ? org.company_name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                    : 'BC';
                document.getElementById('orgInitials').textContent = initials;

                // Build address
                const addressParts = [];
                if (org.address) addressParts.push(org.address);
                if (org.city) addressParts.push(org.city);
                if (org.state) addressParts.push(org.state);
                if (org.pincode) addressParts.push(org.pincode);

                document.getElementById('orgAddress').textContent =
                    addressParts.join(', ') || 'Business Hub, India';

                // Build contact info
                const contactParts = [];
                if (org.phone) contactParts.push(`Phone: ${org.phone}`);
                if (org.email) contactParts.push(`Email: ${org.email}`);
                if (org.gst_number) contactParts.push(`GST: ${org.gst_number}`);

                const orgContact = document.getElementById('orgContact');
                orgContact.innerHTML = contactParts.join('<br>');
            }
        } catch (error) {
            console.error('Error loading organization:', error);
            // Set defaults
            document.getElementById('orgName').textContent = 'Your Company';
            document.getElementById('orgNameFoot').textContent = 'Your Company';
            document.getElementById('orgAddress').textContent = 'Business Hub, India';
        }
    }

    // Load quotation details
    async function loadQuotation() {
        try {
            const response = await axios.get(`${APP_API_URL}/quotations/${quoteId}`);
            currentQuotation = response.data;

            if (!currentQuotation) {
                throw new Error('Quotation not found');
            }

            // Update quotation header
            document.getElementById('qNumber').textContent =
                currentQuotation.quotation_number || `QTN-${currentQuotation.quotation_id}`;
            document.getElementById('qId').textContent = currentQuotation.quotation_id;

            if (currentQuotation.reference) {
                document.getElementById('qReference').textContent = currentQuotation.reference;
            }

            // Format and set dates
            const quoteDate = currentQuotation.quote_date ? new Date(currentQuotation.quote_date) : new Date();
            document.getElementById('qDate').textContent = formatDate(quoteDate);

            if (currentQuotation.valid_until) {
                const validUntil = new Date(currentQuotation.valid_until);
                document.getElementById('qValid').textContent = formatDate(validUntil);

                // Check if expired
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const statusBadge = document.getElementById('qStatus');
                if (validUntil < today) {
                    statusBadge.innerHTML = '<span class="status-text">Expired</span>';
                    statusBadge.style.background = '#fef2f2';
                    statusBadge.style.borderColor = '#fecaca';
                    statusBadge.style.color = '#dc2626';

                    document.getElementById('btnConvertToInvoice').classList.add('disabled');
                    document.getElementById('btnConvertToInvoice').disabled = true;
                    document.getElementById('btnConvertToInvoice').title = 'Cannot convert expired quotation';
                } else {
                    statusBadge.innerHTML = '<span class="status-text">Valid</span>';
                    statusBadge.style.background = '#d1fae5';
                    statusBadge.style.borderColor = '#a7f3d0';
                    statusBadge.style.color = '#059669';
                }
            } else {
                document.getElementById('qValid').textContent = 'Not specified';
                const statusBadge = document.getElementById('qStatus');
                statusBadge.innerHTML = '<span class="status-text">Open</span>';
                statusBadge.style.background = '#fef3c7';
                statusBadge.style.borderColor = '#fde68a';
                statusBadge.style.color = '#d97706';
            }

            // Update customer info
            document.getElementById('qCustomer').textContent =
                currentQuotation.customer_name || 'Customer';

            // Load detailed customer info if available
            if (currentQuotation.customer_id) {
                try {
                    const customerResp = await axios.get(`${APP_API_URL}/customers/${currentQuotation.customer_id}`);
                    const customer = customerResp.data;

                    if (customer) {
                        // Build address
                        const addressParts = [];
                        if (customer.address) addressParts.push(customer.address);
                        if (customer.city) addressParts.push(customer.city);
                        if (customer.state) addressParts.push(customer.state);
                        if (customer.pincode) addressParts.push(customer.pincode);

                        document.getElementById('qCustomerAddress').textContent =
                            addressParts.join(', ') || 'Address not specified';

                        // Build contact info
                        const contactParts = [];
                        if (customer.phone) contactParts.push(`Phone: ${customer.phone}`);
                        if (customer.email) contactParts.push(`Email: ${customer.email}`);

                        const customerContact = document.getElementById('qCustomerContact');
                        customerContact.innerHTML = contactParts.join('<br>');
                    }
                } catch (error) {
                    console.error('Error loading customer details:', error);
                }
            }

            // Update totals
            document.getElementById('qSub').textContent = formatCurrency(currentQuotation.sub_total || 0);
            document.getElementById('qTax').textContent = formatCurrency(currentQuotation.total_tax || 0);
            document.getElementById('qGrand').textContent = formatCurrency(currentQuotation.grand_total || 0);

            // Update items table
            const itemsContainer = document.getElementById('qItems');
            if (currentQuotation.items && currentQuotation.items.length > 0) {
                itemsContainer.innerHTML = currentQuotation.items.map((item, index) => `
                    <tr>
                        <td class="serial">${index + 1}</td>
                        <td class="description">
                            <div class="item-name">${item.item_name || 'Item'}</div>
                            <div class="item-details">
                                ${item.hsn_code ? `HSN: ${item.hsn_code}<br>` : ''}
                                ${item.description || ''}
                            </div>
                        </td>
                        <td class="quantity">${item.qty || 0}</td>
                        <td class="unit">${item.unit || 'pcs'}</td>
                        <td class="rate">${formatCurrency(item.rate || 0)}</td>
                        <td class="tax">${item.tax_percent || 0}%</td>
                        <td class="amount">${formatCurrency(item.total || 0)}</td>
                    </tr>
                `).join('');
            } else {
                itemsContainer.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            No items found in this quotation
                        </td>
                    </tr>
                `;
            }

            // Update notes and terms
            if (currentQuotation.notes && currentQuotation.notes.trim()) {
                document.getElementById('qNotes').textContent = currentQuotation.notes;
                document.getElementById('qNotes').className = 'notes-content';
            }

            if (currentQuotation.terms_conditions && currentQuotation.terms_conditions.trim()) {
                document.getElementById('qTerms').textContent = currentQuotation.terms_conditions;
                document.getElementById('qTerms').className = 'terms-content';
            }

            // Update generated info
            const generatedDate = quoteDate;
            document.getElementById('qGeneratedInfo').textContent =
                `Generated on ${generatedDate.toLocaleString('en-IN', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`;

            // Setup convert button
            const btnConvert = document.getElementById('btnConvertToInvoice');

            if (currentQuotation.invoice_id) {
                // Already converted
                btnConvert.innerHTML = '<i class="bi bi-receipt"></i><span>View Invoice</span>';
                btnConvert.classList.remove('btn-convert');
                btnConvert.classList.add('btn-action');
                btnConvert.onclick = () => {
                    window.location.href = `/invoices/view/${currentQuotation.invoice_id}`;
                };
            } else {
                // Setup conversion
                btnConvert.onclick = () => {
                    if (currentQuotation.valid_until) {
                        const validUntil = new Date(currentQuotation.valid_until);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        if (validUntil < today) {
                            showToast('Cannot convert expired quotation to invoice', 'warning');
                            return;
                        }
                    }
                    window.location.href = `/invoices/create?source_quote_id=${quoteId}`;
                };
            }

        } catch (error) {
            console.error('Error loading quotation:', error);
            let errorMessage = 'Failed to load quotation details';

            if (error.response) {
                if (error.response.status === 404) {
                    errorMessage = 'Quotation not found';
                    showToast(errorMessage, 'danger');
                    setTimeout(() => window.location.href = '/quotations', 2000);
                    return;
                } else if (error.response.data?.detail) {
                    errorMessage = error.response.data.detail;
                }
            }

            showToast(errorMessage, 'danger');

            // Show error state
            document.getElementById('qNumber').textContent = 'Error';
            document.getElementById('qCustomer').textContent = 'Failed to load';
            const statusBadge = document.getElementById('qStatus');
            statusBadge.innerHTML = '<span class="status-text">Error</span>';
            statusBadge.style.background = '#fef2f2';
            statusBadge.style.borderColor = '#fecaca';
            statusBadge.style.color = '#dc2626';

            document.getElementById('btnConvertToInvoice').disabled = true;
        }
    }

    // Format currency
    function formatCurrency(amount) {
        return '₹ ' + parseFloat(amount).toLocaleString('en-IN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Format date
    function formatDate(date) {
        return date.toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    // PDF Generation
    async function generatePDFBlob() {
        if (!currentQuotation) throw new Error('Quotation data not loaded');

        // Load PDF libraries if not already loaded
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

        const element = document.getElementById('printableArea');
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        const imgData = canvas.toDataURL('image/png');

        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        return pdf.output('blob');
    }

    // Download PDF
    async function downloadPDF() {
        if (!currentQuotation) {
            showToast('Quotation data not loaded', 'warning');
            return;
        }

        const button = event.target.closest('.btn-pdf') || event.target;
        const originalHTML = button.innerHTML;

        try {
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i><span>Generating...</span>';

            const blob = await generatePDFBlob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const qNumber = document.getElementById('qNumber').textContent || 'Quotation';
            a.download = `${qNumber}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showToast('PDF downloaded successfully!', 'success');
        } catch (error) {
            console.error('Error generating PDF:', error);
            showToast('Failed to generate PDF. Please try again.', 'danger');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // Load external script
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            if (document.querySelector(`script[src="${src}"]`)) {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // Share Functions
    function shareQuotation() {
        const link = window.location.href;
        document.getElementById('quotationLink').value = link;

        // Show modal
        if (shareModal) {
            shareModal.show();
        }
    }

    // Initialize QR code
    function initQRCode() {
        const link = window.location.href;
        const qrcodeContainer = document.getElementById('qrcode');

        // Load QR code library if needed
        if (typeof QRCode === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
            script.onload = () => generateQRCode(link, qrcodeContainer);
            document.head.appendChild(script);
        } else {
            generateQRCode(link, qrcodeContainer);
        }
    }

    function generateQRCode(link, container) {
        container.innerHTML = '';
        new QRCode(container, {
            text: link,
            width: 128,
            height: 128,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
        });
    }

    // Share File Helper
    async function shareFile(title, text, files) {
        if (navigator.canShare && navigator.canShare({ files })) {
            try {
                await navigator.share({
                    files: files,
                    title: title,
                    text: text
                });
                showToast('Shared successfully', 'success');
                if (shareModal) shareModal.hide();
                return true;
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error sharing file:', error);
                    showToast('Error sharing file: ' + error.message, 'danger');
                }
                return false;
            }
        } else {
            // Fallback for devices that don't support file sharing
            return false;
        }
    }

    // Web Share API
    async function shareViaWebAPI() {
        const btn = document.querySelector('.btn-native-share');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<div class="spinner-border spinner-border-sm text-primary me-2"></div> Preparing...';
        btn.disabled = true;

        try {
            const blob = await generatePDFBlob();
            const qNumber = document.getElementById('qNumber').textContent || 'Quotation';
            const file = new File([blob], `${qNumber}.pdf`, { type: 'application/pdf' });

            const shared = await shareFile(
                `Quotation ${qNumber}`,
                `Here is the quotation ${qNumber}`,
                [file]
            );

            if (!shared) {
                // Fallback to link sharing if file sharing fails/not supported
                await navigator.share({
                    title: `Quotation ${qNumber}`,
                    text: `View quotation ${qNumber}`,
                    url: window.location.href
                });
                showToast('Shared link successfully', 'success');
                if (shareModal) shareModal.hide();
            }
        } catch (error) {
            console.error('Share failed:', error);
            if (error.name !== 'AbortError') {
                showToast('Share failed. Try downloading PDF instead.', 'warning');
            }
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    // WhatsApp Share
    async function shareViaWhatsApp() {
        const btn = document.querySelector('.social-share-btn.whatsapp');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Sending...';
        btn.disabled = true;

        try {
            const blob = await generatePDFBlob();
            const qNumber = document.getElementById('qNumber').textContent || 'Quotation';
            const file = new File([blob], `${qNumber}.pdf`, { type: 'application/pdf' });

            // Try native share first as it's the only way to share files
            const shared = await shareFile(
                `Quotation ${qNumber}`,
                `Here is the quotation ${qNumber}`,
                [file]
            );

            if (!shared) {
                // Platform specific fallback is not possible for files via web
                // Download file and instruct user
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${qNumber}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast('PDF downloaded. Please attach it in WhatsApp.', 'info');
                setTimeout(() => {
                    const text = `Quotation ${qNumber}`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                    if (shareModal) shareModal.hide();
                }, 1000);
            }
        } catch (error) {
            console.error('WhatsApp share failed:', error);
            showToast('Failed to generate PDF', 'danger');
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    // Email Share
    async function shareViaEmail() {
        const btn = document.querySelector('.social-share-btn.email');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Sending...';
        btn.disabled = true;

        try {
            const blob = await generatePDFBlob();
            const qNumber = document.getElementById('qNumber').textContent || 'Quotation';
            const file = new File([blob], `${qNumber}.pdf`, { type: 'application/pdf' });

            const shared = await shareFile(
                `Quotation ${qNumber}`,
                `Here is the quotation ${qNumber}`,
                [file]
            );

            if (!shared) {
                // Download file and open email client
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${qNumber}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast('PDF downloaded. Please attach it to the email.', 'info');
                setTimeout(() => {
                    const subject = `Quotation ${qNumber}`;
                    const body = `Dear Customer,\n\nPlease find the quotation attached.\n\nThank you.`;
                    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    if (shareModal) shareModal.hide();
                }, 1000);
            }
        } catch (error) {
            console.error('Email share failed:', error);
            showToast('Failed to generate PDF', 'danger');
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    // Telegram Share
    async function shareViaTelegram() {
        const btn = document.querySelector('.social-share-btn.telegram');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Sending...';
        btn.disabled = true;

        try {
            const blob = await generatePDFBlob();
            const qNumber = document.getElementById('qNumber').textContent || 'Quotation';
            const file = new File([blob], `${qNumber}.pdf`, { type: 'application/pdf' });

            const shared = await shareFile(
                `Quotation ${qNumber}`,
                `Here is the quotation ${qNumber}`,
                [file]
            );

            if (!shared) {
                // Download file and open Telegram
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${qNumber}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast('PDF downloaded. Please share it in Telegram.', 'info');
                setTimeout(() => {
                    const text = `Quotation ${qNumber}`;
                    window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`, '_blank');
                    if (shareModal) shareModal.hide();
                }, 1000);
            }
        } catch (error) {
            console.error('Telegram share failed:', error);
            showToast('Failed to generate PDF', 'danger');
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    // SMS Share
    async function shareViaSMS() {
        const btn = document.querySelector('.social-share-btn.sms');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Sending...';
        btn.disabled = true;

        try {
            const blob = await generatePDFBlob();
            const qNumber = document.getElementById('qNumber').textContent || 'Quotation';
            const file = new File([blob], `${qNumber}.pdf`, { type: 'application/pdf' });

            const shared = await shareFile(
                `Quotation ${qNumber}`,
                `Here is the quotation ${qNumber}`,
                [file]
            );

            if (!shared) {
                // SMS cannot attach files usually, just link
                showToast('SMS cannot attach files directly. Sharing link instead.', 'info');
                const text = `Quotation ${qNumber} - View: ${window.location.href}`;
                window.location.href = `sms:?body=${encodeURIComponent(text)}`;
                if (shareModal) shareModal.hide();
            }
        } catch (error) {
            console.error('SMS share failed:', error);
            showToast('Failed to generate PDF', 'danger');
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }

    // Copy link to clipboard
    function copyLink() {
        const linkInput = document.getElementById('quotationLink');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);

        navigator.clipboard.writeText(linkInput.value).then(() => {
            showToast('Link copied to clipboard!', 'success');
        }).catch(() => {
            // Fallback for older browsers
            document.execCommand('copy');
            showToast('Link copied to clipboard!', 'success');
        });
    }

    // Email Quotation (Server Side)
    async function sendEmail() {
        if (!currentQuotation) return;

        if (confirm('Send this quotation via email?')) {
            try {
                const response = await axios.post(`${APP_API_URL}/quotations/${quoteId}/email`, {
                    quotation_url: window.location.href
                });
                showToast(response.data.message || 'Email sent successfully', 'success');
            } catch (e) {
                console.error(e);
                const errorMsg = e.response?.data?.detail || 'Failed to send email';
                showToast(errorMsg, 'danger');
            }
        }
    }

    // Duplicate quotation
    async function duplicateQuotation() {
        if (!currentQuotation) return;

        try {
            const response = await axios.post(`${APP_API_URL}/quotations/${quoteId}/duplicate`);
            const { new_quotation_id, quotation_number } = response.data;

            showToast(`Quotation duplicated as ${quotation_number}`, 'success');

            setTimeout(() => {
                window.location.href = `/quotations/view/${new_quotation_id}`;
            }, 1500);
        } catch (e) {
            console.error(e);
            const errorMsg = e.response?.data?.detail || 'Failed to duplicate quotation';
            showToast(errorMsg, 'danger');
        }
    }

    // Delete quotation
    async function deleteQuotation() {
        if (!currentQuotation) return;

        if (confirm('Are you sure you want to delete this quotation? This action cannot be undone.')) {
            try {
                await axios.delete(`${APP_API_URL}/quotations/${quoteId}`);
                showToast('Quotation deleted', 'success');

                setTimeout(() => {
                    window.location.href = '/quotations';
                }, 1500);
            } catch (e) {
                console.error(e);
                showToast('Failed to delete quotation', 'danger');
            }
        }
    }

    // Toast notification
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = toastContainer.querySelector('.toast');
        const toastBody = toast.querySelector('.toast-body');

        // Update toast content
        const icon = toastBody.querySelector('.toast-icon');
        const title = toastBody.querySelector('.toast-title');
        const messageEl = toastBody.querySelector('.toast-message');

        title.textContent = type.charAt(0).toUpperCase() + type.slice(1);
        messageEl.textContent = message;

        // Update icon and colors based on type
        if (type === 'success') {
            icon.className = 'bi bi-check-circle-fill toast-icon success';
            icon.style.color = '#10b981';
        } else if (type === 'warning') {
            icon.className = 'bi bi-exclamation-triangle-fill toast-icon warning';
            icon.style.color = '#f59e0b';
        } else if (type === 'danger') {
            icon.className = 'bi bi-x-circle-fill toast-icon danger';
            icon.style.color = '#ef4444';
        } else {
            icon.className = 'bi bi-info-circle-fill toast-icon info';
            icon.style.color = '#3b82f6';
        }

        // Show toast
        toast.classList.add('show');

        // Auto-hide after 5 seconds
        setTimeout(() => {
            toast.classList.remove('show');
        }, 5000);

        // Close button
        const closeBtn = toastBody.querySelector('.btn-close');
        closeBtn.onclick = () => toast.classList.remove('show');
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', function () {
        // Hide any open modals
        if (shareModal) {
            shareModal.hide();
        }

        // Remove modal-open class
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    });

</script>
{% endblock %}